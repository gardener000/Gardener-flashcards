<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Leitner å­¦ä¹ å¡ç‰‡</title>
<div id="auth-container" style="margin-top: 10px;">
  <button id="loginBtn" class="action-btn">ç™»å½•ä»¥åŒæ­¥æ•°æ® â˜ï¸</button>
  <div id="userInfo" style="display: none; align-items: center; gap: 10px;">
    <span id="userName" style="font-weight: 600;"></span>
    <button id="logoutBtn" class="action-btn secondary">ç™»å‡º</button>
  </div>
</div>
<meta name="description" content="ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ã€æ”¯æŒç¦»çº¿å’Œè‡ªå®šä¹‰çš„ Leitner å­¦ä¹ å¡ç‰‡ PWA åº”ç”¨ã€‚"/>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* ... æ‚¨çš„å…¨éƒ¨ CSS æ ·å¼ä¿æŒä¸å˜ ... */
:root{--bg:hsl(210 20% 98%);--card-bg:hsl(0 0% 100%);--ink:hsl(220 13% 12%);--muted:hsl(220 10% 45%);--accent:hsl(215 90% 55%);--accent-2:hsl(200 80% 45%);--highlight:hsl(48 100% 60%);--radius:14px;--gap:8px;--card-w:min(760px,calc(100vw - 48px));}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#f7f9fc 140%);color:var(--ink);font-family:"Roboto","Open Sans","Noto Sans SC",system-ui,-apple-system,Segoe UI;}
.container{max-width:980px;margin:0 auto;padding:14px;}
header{display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px 4px;}
h1{font-size:20px;margin:0;font-weight:700;}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.mode-btn, .action-btn {background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:999px;font-weight:600;cursor:pointer;}
.action-btn.secondary{background:#fff;color:var(--accent);border:1px solid hsl(215 60% 80%);}
.toolbar{width:100%;display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px;flex-wrap:wrap;}
.progress{flex:1;min-width:160px;margin:0 12px;}
.progress-bar{height:8px;background:hsl(0 0% 90%);border-radius:6px;overflow:hidden;}
.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s ease;}
.stats{min-width:220px;background:linear-gradient(180deg, #fff, #fbfdff);border-radius:12px;padding:8px 10px;border:1px solid hsl(220 10% 94%);box-shadow:0 6px 20px rgba(16,24,40,0.06);font-size:13px;color:var(--muted);}
.stats strong{color:var(--ink);font-weight:700;}
.app{display:flex;justify-content:center;padding:18px 10px;}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));width:var(--card-w);align-items:start;justify-items:center;}
.card{width:100%;max-width:420px;perspective:1200px;}
.card__inner{position:relative;width:100%;padding-top:133%;transform-style:preserve-3d;transition:transform 600ms cubic-bezier(.2,.9,.2,1);border-radius:var(--radius);box-shadow:0 8px 24px rgba(16,24,40,0.09);}
.face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:calc(var(--gap)*4);background:linear-gradient(180deg,var(--card-bg),#fbfdff);border:1px solid hsl(220 10% 94%);overflow:auto;}
.front{transform:rotateY(0deg);}
.back{transform:rotateY(180deg);text-align:left;align-items:flex-start;}
.front h2{font-size:clamp(18px,4.2vw,22px);margin:0;font-weight:700;text-align:center;}
.subtitle{margin-top:8px;color:var(--muted);font-size:13px;text-align:center;}
.hr{width:48px;height:4px;border-radius:4px;background:linear-gradient(90deg,var(--accent),#6ea8ff);margin:10px 0;}
dl{margin:0;}
dt{font-weight:700;margin-top:8px;font-size:14px;}
dd{margin:6px 0 12px 0;padding-left:14px;color:var(--muted);font-size:13px;}
mark{background:linear-gradient(120deg,var(--highlight) 0%,rgba(255,225,115,0.35) 100%);padding:0 4px;border-radius:4px;}
.btn-area{display:flex;gap:8px;justify-content:center;margin-top:12px;}
.flip-btn{background:transparent;color:var(--accent);border:2px solid transparent;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
.remember-btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;}
.remember-btn.low{background:#ffb74d;}
.remember-btn.high{background:#4caf50;}
.card[data-flipped="true"] .card__inner{transform:rotateY(180deg);}
.grid.single .card{display:none;}
.grid.single .card.current{display:block;}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:none;}
.toast.show{display:block;opacity:0;animation:fadeIn .28s forwards;}
@keyframes fadeIn{to{opacity:1;transform:translateX(-50%) translateY(-4px);}}
.flip-btn:focus,.mode-btn:focus,.remember-btn:focus,.action-btn:focus{outline:3px solid rgba(34,100,255,0.12);outline-offset:3px;border-radius:8px;}
@media (max-width:420px){:root{font-size:15px;}header{padding:10px 6px;} .stats{min-width:160px;font-size:12px;} .container{padding:8px;}}
/* ==================================
   å¼¹çª—ç¾åŒ–ä¸å¢å¼ºæ ·å¼ (è¿½åŠ åœ¨æœ«å°¾)
   ================================== */

/* --- 1. å¼¹çª—é€šç”¨æ ·å¼å‡çº§ --- */
.modal {
  display: none; 
  position: fixed; 
  z-index: 1000; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
  left: 0; top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto; 
  background-color: rgba(0, 0, 0, 0.6); /* èƒŒæ™¯æ›´æš—ï¼Œçªå‡ºå¼¹çª— */
  display: flex; /* ä½¿ç”¨ Flexbox å®ç°å‚ç›´å±…ä¸­ */
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal.show {
  opacity: 1;
}

.modal-content {
  background-color: #ffffff;
  margin: auto; /* Flexbox ä¼šå¤„ç†å±…ä¸­ï¼Œè¿™é‡Œè®¾ä¸º auto */
  padding: 24px 32px;
  border: none; /* ç§»é™¤æ—§è¾¹æ¡† */
  width: 90%; 
  max-width: 700px;
  border-radius: var(--radius);
  position: relative;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  transform: scale(0.95);
  transition: transform 0.3s ease;
}

.modal.show .modal-content {
  transform: scale(1);
}

.modal-content h2 {
  margin-top: 0;
  margin-bottom: 16px;
  font-size: 22px;
  color: var(--ink);
  border-bottom: 1px solid #eee;
  padding-bottom: 12px;
}

.modal-close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s, transform 0.2s;
}

.modal-close-btn:hover {
  color: var(--ink);
  transform: rotate(90deg);
}

/* --- 2. å¡ç‰‡ç¼–è¾‘å™¨ä¸“å±ç¾åŒ– --- */
#cardEditorForm label {
  display: block;
  margin-top: 16px;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
  color: var(--muted);
}

#cardEditorForm textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-family: inherit;
  font-size: 16px;
  box-sizing: border-box;
  resize: vertical;
  transition: border-color 0.2s, box-shadow 0.2s;
}

#cardEditorForm textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(34, 100, 255, 0.12);
}

.editor-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 4px;
}

.preview {
  border: 1px dashed #e0e0e0; /* ä½¿ç”¨è™šçº¿è¾¹æ¡†åŒºåˆ† */
  border-radius: 8px;
  padding: 12px;
  background-color: #f9f9f9;
  min-height: 140px;
  font-size: 14px;
  overflow-y: auto;
  color: #333;
}
/* Markdown é¢„è§ˆæ ·å¼ */
.preview h1, .preview h2, .preview h3 { margin-top: 0; }
.preview p { margin: 0 0 8px 0; }
.preview code { background-color: #eee; padding: 2px 4px; border-radius: 4px; }
.preview ul, .preview ol { padding-left: 20px; }

.form-actions {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid #eee;
  text-align: right;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* åœ¨å°å±å¹•ä¸Šï¼Œç¼–è¾‘å™¨å˜ä¸ºå•åˆ— */
@media (max-width: 768px) {
  .editor-container {
    grid-template-columns: 1fr;
  }
}
/* ==================================
   æŒ‰é’®äº¤äº’ä¸å…‰æ ‡ä¿®å¤
   ================================== */

/* 1. ä¸ºæ‰€æœ‰æŒ‰é’®ï¼ˆåŒ…æ‹¬<select>ä¼ªè£…çš„æŒ‰é’®ï¼‰è®¾ç½®åŸºç¡€äº¤äº’æ ·å¼ */
.mode-btn, .action-btn, .flip-btn, .remember-btn, .edit-btn, #set-select {
  /* ç¡®ä¿å…‰æ ‡æ€»æ˜¯æ‰‹å‹ */
  cursor: pointer;
  
  /* æ·»åŠ è¿‡æ¸¡æ•ˆæœï¼Œè®©æ‚¬åœæ›´å¹³æ»‘ */
  transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
  
  /* é˜²æ­¢ç”¨æˆ·é€‰æ‹©æŒ‰é’®å†…çš„æ–‡å­— */
  user-select: none; 
}

/* 2. å®šä¹‰ç»Ÿä¸€çš„æ‚¬åœå’Œç‚¹å‡»æ•ˆæœ */
/* æˆ‘ä»¬ä¸ºæœ‰èƒŒæ™¯è‰²çš„æŒ‰é’®å®šä¹‰ä¸€ç§æ•ˆæœ */
.mode-btn:hover, .action-btn:hover, .remember-btn:hover {
  transform: translateY(-2px);
  opacity: 0.9; /* è½»å¾®å˜æ·¡ï¼Œå¢åŠ åé¦ˆ */
}
.mode-btn:active, .action-btn:active, .remember-btn:active {
  transform: translateY(0);
  opacity: 1;
}

/* 3. ä¸ºé€æ˜/ç‰¹æ®ŠæŒ‰é’®å®šä¹‰å¦ä¸€ç§æ•ˆæœ */
.flip-btn:hover, .edit-btn:hover {
  background-color: rgba(0, 0, 0, 0.05); /* æ·»åŠ ä¸€ä¸ªè½»å¾®çš„èƒŒæ™¯åé¦ˆ */
  transform: scale(1.1);
}
.flip-btn:active, .edit-btn:active {
  transform: scale(1);
}


.edit-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: transparent;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
</style>
</head>
<body>
<!-- HTML ç»“æ„ä¸ä¹‹å‰ç¨³å®šç‰ˆä¸€è‡´ -->
<div class="container" role="application">
  <header>
    <h1 id="title">Leitner å­¦ä¹ å¡ç‰‡</h1>
    <div style="margin: 12px 0; display: flex; align-items: center; gap: 16px;">
      <div class="card-set-selector">
        <label for="set-select" style="font-weight: 600; margin-right: 8px;">é€‰æ‹©å¡ç‰‡ç»„:</label>
        <select id="set-select" class="action-btn secondary" style="padding-right: 24px;"></select>
      </div>
      <button class="action-btn" id="createNewCardBtn" title="ä¸ºå½“å‰å¡ç‰‡ç»„åˆ›å»ºæ–°å¡ç‰‡">åˆ›å»ºå¡ç‰‡ â•</button>
    </div>
    <div class="controls toolbar" role="toolbar">
      <button class="mode-btn" id="modeToggle">åˆ‡æ¢åˆ°æŠ½è®¤å¡æ¨¡å¼ ğŸ´</button>
      <button class="action-btn secondary" id="showGlobalStatsBtn" title="æŸ¥çœ‹æ‰€æœ‰å¡ç‰‡ç»„çš„ç»Ÿè®¡">å…¨å±€ç»Ÿè®¡ ğŸ“Š</button>
      <div class="progress" title="å¤ä¹ è¿›åº¦">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      <div class="stats" id="statsPanel" role="status">
        <div><strong id="statSummary">åŠ è½½ä¸­â€¦</strong></div>
        <div style="margin-top:6px; font-size:13px; color:var(--muted);">
          <div>æ€»å¡ç‰‡ï¼š<strong id="totalCount">0</strong></div>
          <div>Leitner ç®±åˆ†å¸ƒï¼š<span id="levels">â€”</span></div>
          <div>å¤ä¹ æ¬¡æ•°ï¼š<span id="reviewCount">0</span> Â· ä¸Šæ¬¡å¤ä¹ ï¼š<span id="lastReview">â€”</span></div>
        </div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
          <button class="action-btn" id="resetBtn" title="é‡ç½®å½“å‰å¡ç‰‡ç»„çš„æ‰€æœ‰è¿›åº¦">é‡ç½®è¿›åº¦ â™»ï¸</button>
          <button class="action-btn" id="notifyToggle" title="å¼€å¯/å…³é—­é¡µé¢æ¯æ—¥æé†’">æé†’ï¼šå¼€å¯</button>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap: 8px;">
        <select id="test-push-select" class="action-btn secondary" style="padding-right: 24px;">
          <option value="random">éšæœºå¡ç‰‡æé†’</option>
          <option value="general">é€šç”¨å¤ä¹ æé†’</option>
          <option value="congrats">å®Œæˆç¥è´º</option>
        </select>
        <button class="action-btn" id="testPushBtn">å‘é€æµ‹è¯• ğŸ””</button>
      </div>
      <button class="action-btn secondary" id="installBtn" style="display:none;">å®‰è£…åº”ç”¨ â¤“</button>
    </div>
  </header>
  <main class="app" id="main"><section class="grid" id="cardGrid"></section></main>
</div>

<div id="globalStatsModal" class="modal"><div class="modal-content"><span class="modal-close-btn" id="closeModalBtn">&times;</span><h2>å…¨å±€å­¦ä¹ ç»Ÿè®¡</h2><p>è¿™é‡Œæ±‡æ€»äº†æ‚¨æ‰€æœ‰å¡ç‰‡ç»„çš„å­¦ä¹ è¿›åº¦ã€‚</p><div class="chart-container" style="position: relative; height: 300px; width: 100%;"><canvas id="leitnerChart"></canvas></div><div id="smart-reminder-info" style="margin-top: 20px; text-align: center; font-style: italic;"></div></div></div>
<div id="cardEditorModal" class="modal"><div class="modal-content"><span class="modal-close-btn" id="closeEditorBtn">&times;</span><h2 id="editorTitle">åˆ›å»ºæ–°å¡ç‰‡</h2><form id="cardEditorForm"><input type="hidden" id="editingCardIndex"><label for="cardFront">æ­£é¢ (æ”¯æŒ HTML):</label><textarea id="cardFront" rows="3" required></textarea><label for="cardBack">èƒŒé¢ (æ”¯æŒ Markdown):</label><div class="editor-container"><textarea id="cardBack" rows="6" required></textarea><div id="markdownPreview" class="preview"></div></div><div class="form-actions"><button type="submit" class="action-btn" id="saveCardBtn">ä¿å­˜</button><button type="button" class="action-btn secondary" id="deleteCardBtn" style="display: none;">åˆ é™¤</button></div></form></div></div>
<div class="toast" id="toast"></div>
<script type="module">
/* ==================================
   åº”ç”¨ä¸»è„šæœ¬ (å•æ–‡ä»¶ç¨³å®šç‰ˆ)
   ================================== */

// --- 1. é…ç½®ä¸æ¨¡å—å¯¼å…¥ ---
import * as firebase from './js/firebase.js';
import { migrateLocalDataToFirestore } from './js/migration.js';
import { cardSetsConfig } from './data/sets.js';

// --- 2. å…¨å±€çŠ¶æ€å˜é‡ ---
let currentUser = null; // ç”¨äºä¿å­˜å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯
let currentSetId = 'threads';
let cardsData = [];
let leitner, stats, settings;
let mode = 'grid';
let reviewQueue = [];
let currentIndex = 0;
let autoFlipTimer = null;
let deferredPrompt = null;
let leitnerChartInstance = null;

// --- 3. DOM å…ƒç´ è·å– ---
const grid = document.getElementById('cardGrid');
const progressFill = document.getElementById('progressFill');
const modeToggle = document.getElementById('modeToggle');
const totalCountEl = document.getElementById('totalCount');
const levelsEl = document.getElementById('levels');
const reviewCountEl = document.getElementById('reviewCount');
const lastReviewEl = document.getElementById('lastReview');
const statSummary = document.getElementById('statSummary');
const notifyToggle = document.getElementById('notifyToggle');
const toast = document.getElementById('toast');
const titleEl = document.getElementById('title');
const setSelect = document.getElementById('set-select');
const resetBtn = document.getElementById('resetBtn');
const testPushBtn = document.getElementById('testPushBtn');
const testPushSelect = document.getElementById('test-push-select');
const installBtn = document.getElementById('installBtn');
// Modal & Editor elements
const showGlobalStatsBtn = document.getElementById('showGlobalStatsBtn');
const globalStatsModal = document.getElementById('globalStatsModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const smartReminderInfo = document.getElementById('smart-reminder-info');
const leitnerChartCanvas = document.getElementById('leitnerChart');
const createNewCardBtn = document.getElementById('createNewCardBtn');
const cardEditorModal = document.getElementById('cardEditorModal');
const closeEditorBtn = document.getElementById('closeEditorBtn');
const cardEditorForm = document.getElementById('cardEditorForm');
const editorTitle = document.getElementById('editorTitle');
const cardFrontInput = document.getElementById('cardFront');
const cardBackInput = document.getElementById('cardBack');
const markdownPreview = document.getElementById('markdownPreview');
const editingCardIndexInput = document.getElementById('editingCardIndex');
const deleteCardBtn = document.getElementById('deleteCardBtn');

// --- 4. æ•°æ®æŒä¹…åŒ– ---
function getStorageKeys(setId) { return { LEITNER: `flash_leitner_${setId}_v2`, STATS: `flash_stats_${setId}_v2`, SETTINGS: 'flash_settings_v2', CARDS: `flash_cards_${setId}_v2` }; }
function loadJSON(key) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch (e) { return null; } }
function saveJSON(key, obj) { try { localStorage.setItem(key, JSON.stringify(obj)); } catch (e) {} }
function initLeitner() { const obj = {}; for (let i = 0; i < cardsData.length; i++) obj[i] = 1; return obj; }
function initStats() { const s = {}; for (let i = 0; i < cardsData.length; i++) s[i] = { again: 0, remember: 0, last: 0 }; return s; }

function loadProgress() {
  const STORAGE_KEYS = getStorageKeys(currentSetId);
  leitner = loadJSON(STORAGE_KEYS.LEITNER) || initLeitner();
  stats = loadJSON(STORAGE_KEYS.STATS) || initStats();
  settings = loadJSON(STORAGE_KEYS.SETTINGS) || { remindersEnabled: true };
}

function updateAuthUI(user) {
  const loginBtn = document.getElementById('loginBtn');
  const userInfoDiv = document.getElementById('userInfo');
  const userNameSpan = document.getElementById('userName');

  if (user) {
    currentUser = user;
    loginBtn.style.display = 'none';
    userInfoDiv.style.display = 'flex';
    userNameSpan.textContent = `æ¬¢è¿, ${user.displayName || user.email}`;
    // å¯é€‰ï¼šç¦ç”¨â€œåˆ›å»º/ç¼–è¾‘â€ç­‰åŠŸèƒ½ï¼Œç›´åˆ°æ•°æ®åŠ è½½å®Œæ¯•
  } else {
    currentUser = null;
    loginBtn.style.display = 'block';
    userInfoDiv.style.display = 'none';
  }
}

function persistAll() {
  const STORAGE_KEYS = getStorageKeys(currentSetId);
  saveJSON(STORAGE_KEYS.LEITNER, leitner);
  saveJSON(STORAGE_KEYS.STATS, stats);
  saveJSON(STORAGE_KEYS.SETTINGS, settings);
}
// ã€æ›¿æ¢ã€‘åŸæ¥çš„ switchCardSet å‡½æ•°
async function switchCardSet(newSetId) {
  if (!cardSetsConfig[newSetId]) return;

  // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œåˆ™é€€å›åˆ°æ—§çš„æœ¬åœ°æ¨¡å¼
  if (!currentUser) {
    return switchCardSetLocal(newSetId); // æˆ‘ä»¬éœ€è¦æŠŠæ—§é€»è¾‘æ”¾åˆ°ä¸€ä¸ªæ–°å‡½æ•°é‡Œ
  }

  showToast(`æ­£åœ¨ä»äº‘ç«¯åŒæ­¥: ${cardSetsConfig[newSetId].name}...`);
  grid.classList.add('fade-out');
  await new Promise(resolve => setTimeout(resolve, 450));

  try {
    // 1. ä» Firestore è·å–å¡ç‰‡æ•°æ®
    let setData = await firebase.getCardSet(currentUser.uid, newSetId);
    
    // å¦‚æœäº‘ç«¯æ²¡æœ‰è¿™ä»½æ•°æ®ï¼ˆä¾‹å¦‚æ˜¯æ–°ç”¨æˆ·ï¼‰ï¼Œåˆ™ä»æ¨¡æ¿æ–‡ä»¶åŠ è½½å¹¶ä¸Šä¼ 
    if (!setData) {
      console.log(`äº‘ç«¯æ— æ•°æ®ï¼Œä¸ºç”¨æˆ· ${currentUser.uid} åˆ›å»º ${newSetId}`);
      const module = await import(cardSetsConfig[newSetId].path);
      const templateData = module.default.data;
      setData = { name: cardSetsConfig[newSetId].name, cards: templateData };
      await firebase.saveCardSet(currentUser.uid, newSetId, setData);
    }
    
    // 2. ä» Firestore è·å–å­¦ä¹ è¿›åº¦
    const progressData = await firebase.getProgress(currentUser.uid, newSetId);
    
    // 3. æ›´æ–°å…¨å±€çŠ¶æ€
    currentSetId = newSetId;
    cardsData = setData.cards;
    leitner = progressData?.leitner || initLeitner();
    stats = progressData?.stats || initStats();
    
    // 4. æ¸²æŸ“UI
    if (mode === 'review') exitReviewMode();
    renderGrid();
    updateStatsUI();
    updateSettingsUI();
    titleEl.textContent = `${setData.name} â€” Leitner æŠ½è®¤å¡`;

  } catch (error) {
    console.error(`ä» Firestore åŠ è½½å¡ç‰‡ç»„å¤±è´¥: ${newSetId}`, error);
    showToast('ä»äº‘ç«¯åŒæ­¥å¤±è´¥ï¼', 3000);
  } finally {
    grid.classList.remove('fade-out');
  }
}
// --- 5. æ ¸å¿ƒé€»è¾‘ï¼šå¡ç‰‡ç»„åˆ‡æ¢ä¸åŠ è½½ ---
async function switchCardSetLocal(newSetId) {
  if (!cardSetsConfig[newSetId]) return;
  showToast(`æ­£åœ¨åŠ è½½: ${cardSetsConfig[newSetId].name}...`);
  grid.classList.add('fade-out');
  await new Promise(resolve => setTimeout(resolve, 450));
  try {
    const storageKey = getStorageKeys(newSetId).CARDS;
    let currentCards = loadJSON(storageKey);
    if (!currentCards) {
      const module = await import(cardSetsConfig[newSetId].path);
      currentCards = module.default.data;
      saveJSON(storageKey, currentCards);
    }
    currentSetId = newSetId;
    cardsData = currentCards;
    localStorage.setItem('flash_last_set_id_v1', newSetId);
    if (mode === 'review') exitReviewMode();
    loadProgress();
    renderGrid();
    updateStatsUI();
    updateSettingsUI();
    titleEl.textContent = `${cardSetsConfig[currentSetId].name} â€” Leitner æŠ½è®¤å¡`;
  } catch (error) {
    console.error(`åŠ è½½å¡ç‰‡ç»„å¤±è´¥: ${newSetId}`, error);
    showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚', 3000);
  } finally {
    grid.classList.remove('fade-out');
    updateSWTodo();
  }
}

// --- 6. UIæ¸²æŸ“ä¸äº¤äº’ ---
function renderGrid() {
  grid.innerHTML = '';
  cardsData.forEach((c, i) => {
    const article = document.createElement('article');
    article.className = 'card';
    article.setAttribute('role', 'listitem');
    article.setAttribute('tabindex', '0');
    article.dataset.index = i;
    article.dataset.flipped = 'false';
    article.innerHTML = `
      <div class="card__inner">
        <section class="face front"><h2>${c.front}</h2><div class="subtitle">Leitner ç­‰çº§ï¼š<strong>${leitner[i] || 1}</strong></div><div class="hr"></div><div class="btn-area"><button class="flip-btn">æŸ¥çœ‹ â†º</button></div></section>
        <section class="face back"><button class="edit-btn" onclick="window.app.editCard(${i})">âœï¸</button><div class="content">${marked.parse(c.back)}</div><div class="btn-area"><button class="remember-btn low" data-action="again">å†çœ‹ ğŸ”</button><button class="remember-btn high" data-action="remember">è®°ä½ âœ…</button></div></section>
      </div>`;
    grid.appendChild(article);
  });
  totalCountEl.textContent = cardsData.length;
  attachCardEvents();
}
function updateStatsUI() {
    const total = cardsData.length;
    totalCountEl.textContent = total;
    const counts = [0, 0, 0, 0, 0, 0];
    let reviewTotal = 0, last = 0;
    for (let i = 0; i < total; i++) {
        const level = leitner[i] || 1;
        counts[level]++;
        if (stats[i] && stats[i].last) {
            reviewTotal += (stats[i].again || 0) + (stats[i].remember || 0);
            last = Math.max(last, stats[i].last);
        }
    }
    levelsEl.innerHTML = `1:<strong>${counts[1]}</strong> 2:<strong>${counts[2]}</strong> 3:<strong>${counts[3]}</strong> 4:<strong>${counts[4]}</strong> 5:<strong>${counts[5]}</strong>`;
    reviewCountEl.textContent = reviewTotal;
    lastReviewEl.textContent = last ? new Date(last).toLocaleString() : 'â€”';
    let remembered = 0, attempts = 0;
    for (let i = 0; i < total; i++) {
        const s = stats[i] || { again: 0, remember: 0 };
        remembered += s.remember || 0;
        attempts += (s.remember || 0) + (s.again || 0);
    }
    const rate = attempts ? Math.round((remembered / attempts) * 100) : 0;
    statSummary.textContent = `æŒæ¡ç‡ï¼š${rate}% Â· ç®±1ä¼˜å…ˆå¤ä¹ `;
    const studied = Object.values(stats).filter(s => s && (s.remember || s.again)).length;
    const pct = total > 0 ? Math.round((studied / total) * 100) : 0;
    progressFill.style.width = pct + '%';
}
function updateSettingsUI() { if (settings) notifyToggle.textContent = 'æé†’ï¼š' + (settings.remindersEnabled ? 'å¼€å¯' : 'å…³é—­'); }
function showToast(text, ms = 2400) { toast.textContent = text; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), ms); }
function attachCardEvents() {
    grid.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', e => {
            const target = e.target;
            
            // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯æŸä¸ªæŒ‰é’®
            const button = target.closest('button');
            if (button) {
                // å¦‚æœæ˜¯æŒ‰é’®ï¼Œæ ¹æ®ç±»åæˆ–å±æ€§æ‰§è¡Œä¸åŒæ“ä½œ
                if (button.classList.contains('edit-btn')) {
                    // ç¼–è¾‘æŒ‰é’®æœ‰è‡ªå·±çš„ onclickï¼Œè¿™é‡Œå¯ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼Œæˆ–è€… e.stopPropagation()
                    return; 
                }
                if (button.classList.contains('flip-btn')) {
                    toggleFlip(card);
                    return;
                }
                if (button.dataset.action) {
                    handleRemember(card, button.dataset.action);
                    return;
                }
            }
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¯æ“ä½œçš„æŒ‰é’®ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œé»˜è®¤è¡Œä¸ºï¼šç¿»è½¬å¡ç‰‡
            toggleFlip(card);
        });
        
        // keydown ç›‘å¬å™¨ä¿æŒä¸å˜
        card.addEventListener('keydown', e => { 
            if (e.key === 'Enter' || e.key === ' ') { 
                toggleFlip(card); 
                e.preventDefault(); 
            } 
            if (e.key === 'ArrowRight' && mode === 'review') {
                nextCard();
            }
        });
    });
}
function toggleFlip(card, force) {
    const flipped = card.dataset.flipped === 'true';
    const next = (typeof force === 'boolean') ? force : !flipped;
    card.dataset.flipped = next ? 'true' : 'false';
    clearTimeout(autoFlipTimer);
    if (!next) autoFlipTimer = setTimeout(() => { card.dataset.flipped = 'true'; }, 5000);
}
function handleRemember(card, action) {
    const idx = Number(card.dataset.index);
    const prevLevel = leitner[idx] || 1;
    stats[idx] = stats[idx] || { again: 0, remember: 0, last: 0 };
    if (action === 'remember') {
        leitner[idx] = Math.min(prevLevel + 1, 5);
        stats[idx].remember = (stats[idx].remember || 0) + 1;
    } else {
        leitner[idx] = 1;
        stats[idx].again = (stats[idx].again || 0) + 1;
    }
    stats[idx].last = Date.now();
    if (currentUser) {
    // ç™»å½•çŠ¶æ€ä¸‹ï¼Œå¼‚æ­¥ä¿å­˜è¿›åº¦åˆ° Firestore
    const progressData = { leitner, stats };
    firebase.saveProgress(currentUser.uid, currentSetId, progressData)
      .then(() => console.log('è¿›åº¦å·²åŒæ­¥åˆ°äº‘ç«¯'))
      .catch(err => console.error('è¿›åº¦åŒæ­¥å¤±è´¥', err));
  } else {
    // æœªç™»å½•çŠ¶æ€ä¸‹ï¼Œä¿å­˜åˆ° localStorage
    persistAll();
  }
  
  showToast(action === 'remember' ? 'å·²æ ‡ä¸ºã€Œè®°ä½ã€âœ…' : 'å·²æ ‡ä¸ºã€Œå†çœ‹ã€ğŸ”');
  if (mode === 'review') nextCard(); else updateStatsUI();
}
function startReviewMode() {
    mode = 'review';
    modeToggle.textContent = 'é€€å‡ºæŠ½è®¤å¡æ¨¡å¼ ğŸ ';
    grid.classList.add('single');
    reviewQueue = buildReviewQueue();
    if (reviewQueue.length === 0) { showToast('æš‚æ— éœ€è¦å¤ä¹ çš„å¡ç‰‡ã€‚'); exitReviewMode(); return; }
    currentIndex = 0;
    showCurrentReviewCard();
}
function exitReviewMode() {
    mode = 'grid';
    modeToggle.textContent = 'åˆ‡æ¢åˆ°æŠ½è®¤å¡æ¨¡å¼ ğŸ´';
    grid.classList.remove('single');
    document.querySelectorAll('.card').forEach(c => { c.classList.remove('current'); c.dataset.flipped = 'false'; });
    clearTimeout(autoFlipTimer);
}
function showCurrentReviewCard() {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('current'));
    const card = reviewQueue[currentIndex];
    if (!card) return;
    card.classList.add('current');
    card.dataset.flipped = 'false';
    clearTimeout(autoFlipTimer);
    autoFlipTimer = setTimeout(() => { card.dataset.flipped = 'true'; }, 3000);
    card.focus();
}
function nextCard() { currentIndex++; if (currentIndex >= reviewQueue.length) { reviewQueue = buildReviewQueue(); currentIndex = 0; if (reviewQueue.length === 0) { exitReviewMode(); return; } } showCurrentReviewCard(); }
function prevCard() { currentIndex--; if (currentIndex < 0) { currentIndex = reviewQueue.length - 1; } showCurrentReviewCard(); }
function buildReviewQueue() {
    const list = [];
    grid.querySelectorAll('.card').forEach(c => {
        const idx = Number(c.dataset.index);
        const weight = Math.max(1, 6 - (leitner[idx] || 1));
        for (let i = 0; i < weight; i++) list.push(c);
    });
    return shuffle(list);
}
function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
function setupSwipeGestures() {
    let touchStartX = 0;
    grid.addEventListener('touchstart', e => { if (mode === 'review') touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    grid.addEventListener('touchend', e => {
        if (mode !== 'review') return;
        const touchEndX = e.changedTouches[0].screenX;
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) < 50) return;
        if (swipeDistance < 0) nextCard(); else prevCard();
    });
}

// --- 7. ç¼–è¾‘å™¨ä¸ç»Ÿè®¡å›¾è¡¨ ---
function openCardEditor() { 
  editorTitle.textContent = 'åˆ›å»ºæ–°å¡ç‰‡'; 
  cardEditorForm.reset(); 
  editingCardIndexInput.value = ''; 
  markdownPreview.innerHTML = ''; 
  deleteCardBtn.style.display = 'none'; 
  cardEditorModal.style.display = 'flex';
  setTimeout(() => cardEditorModal.classList.add('show'), 10);
  cardFrontInput.focus();
}
function editCard(index) {
    const card = cardsData[index];
    if (!card) return;
    editorTitle.textContent = 'ç¼–è¾‘å¡ç‰‡';
    cardEditorForm.reset();
    editingCardIndexInput.value = index;
    cardFrontInput.value = card.front;
    cardBackInput.value = card.back;
    markdownPreview.innerHTML = marked.parse(card.back);
    deleteCardBtn.style.display = 'inline-block';
    cardEditorModal.style.display = 'flex';
    setTimeout(() => cardEditorModal.classList.add('show'), 10);
}
function closeCardEditorModal() {
  cardEditorModal.classList.remove('show');
  setTimeout(() => cardEditorModal.style.display = 'none', 300);
}
async function saveCard(event) {
    event.preventDefault();
  
  const index = editingCardIndexInput.value;
  const newCard = { front: cardFrontInput.value, back: cardBackInput.value };

  if (index) {
    cardsData[index] = newCard;
  } else {
    cardsData.push(newCard);
  }
  
  // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œåˆ™ä¿å­˜åˆ° Firestore
  if (currentUser) {
    showToast('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...');
    const setData = { name: cardSetsConfig[currentSetId].name, cards: cardsData };
    await firebase.saveCardSet(currentUser.uid, currentSetId, setData);
  } else {
    // æœªç™»å½•åˆ™ä¿å­˜åˆ° localStorage (ä¿æŒæœ¬åœ°æ¨¡å¼å¯ç”¨)
    saveJSON(getStorageKeys(currentSetId).CARDS, cardsData);
  }

  closeCardEditorModal();
  showToast('å¡ç‰‡å·²ä¿å­˜ï¼');
  renderGrid();
  updateStatsUI();
}
// ã€æ›¿æ¢ã€‘deleteCard å‡½æ•°
async function deleteCard() {
  const index = editingCardIndexInput.value;
  if (index === '' || !confirm('ç¡®è®¤åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿ')) return;

  cardsData.splice(index, 1);
  reindexProgressData(index); // å…ˆåœ¨æœ¬åœ°é‡æ’è¿›åº¦
  
  if (currentUser) {
    showToast('æ­£åœ¨ä»äº‘ç«¯åˆ é™¤...');
    // åŒæ—¶æ›´æ–°äº‘ç«¯çš„å¡ç‰‡å’Œè¿›åº¦
    const setData = { name: cardSetsConfig[currentSetId].name, cards: cardsData };
    const progressData = { leitner, stats };
    await Promise.all([
      firebase.saveCardSet(currentUser.uid, currentSetId, setData),
      firebase.saveProgress(currentUser.uid, currentSetId, progressData)
    ]);
  } else {
    saveJSON(getStorageKeys(currentSetId).CARDS, cardsData);
    persistAll(); // persistAll ä¼šä¿å­˜ leitner å’Œ stats
  }

  closeCardEditorModal();
  showToast('å¡ç‰‡å·²åˆ é™¤ï¼');
  renderGrid();
  updateStatsUI();
}
function reindexProgressData(deletedIndex) {
    const newLeitner = {}, newStats = {};
    const deletedIdxNum = parseInt(deletedIndex, 10);
    for (const oldIndexStr in leitner) {
        const oldIndexNum = parseInt(oldIndexStr, 10);
        let newIndex = oldIndexNum;
        if (oldIndexNum > deletedIdxNum) newIndex = oldIndexNum - 1;
        else if (oldIndexNum === deletedIdxNum) continue;
        newLeitner[newIndex] = leitner[oldIndexStr];
        if (stats[oldIndexStr]) newStats[newIndex] = stats[oldIndexStr];
    }
    leitner = newLeitner;
    stats = newStats;
    persistAll();
}
function aggregateAllStats() {
    const allStats = { totalCards: 0, leitnerDistribution: [0, 0, 0, 0, 0], setsToReview: {} };
    for (const setId in cardSetsConfig) {
        const leitnerData = loadJSON(getStorageKeys(setId).LEITNER);
        if (leitnerData) {
            let reviewableCount = 0;
            Object.values(leitnerData).forEach(level => {
                allStats.totalCards++;
                if (level >= 1 && level <= 5) allStats.leitnerDistribution[level - 1]++;
                if (level <= 2) reviewableCount++;
            });
            if (reviewableCount > 0) allStats.setsToReview[cardSetsConfig[setId].name] = reviewableCount;
        }
    }
    return allStats;
}
function showGlobalStats() {
    const stats = aggregateAllStats();
    const setsToReview = Object.keys(stats.setsToReview);
    if (setsToReview.length > 0) smartReminderInfo.textContent = `ä»Šå¤©å»ºè®®ä¼˜å…ˆå¤ä¹ ï¼š${setsToReview.join(', ')}ã€‚`;
    else smartReminderInfo.textContent = 'å¤ªæ£’äº†ï¼æ‰€æœ‰å¡ç‰‡éƒ½å·²ç†Ÿç»ƒæŒæ¡ã€‚';
    const chartData = { labels: ['ç®± 1', 'ç®± 2', 'ç®± 3', 'ç®± 4', 'ç®± 5'], datasets: [{ label: 'å¡ç‰‡åˆ†å¸ƒ', data: stats.leitnerDistribution, backgroundColor: ['rgba(255, 99, 132, 0.5)','rgba(255, 159, 64, 0.5)','rgba(255, 205, 86, 0.5)','rgba(75, 192, 192, 0.5)','rgba(54, 162, 235, 0.5)'], borderWidth: 1 }] };
    if (leitnerChartInstance) leitnerChartInstance.destroy();
    leitnerChartInstance = new Chart(leitnerChartCanvas, { type: 'bar', data: chartData, options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'å¡ç‰‡æ•°é‡' } } }, plugins: { title: { display: true, text: `Leitner ç®±åˆ†å¸ƒ (æ€»å¡ç‰‡æ•°: ${stats.totalCards})` }, legend: { display: false } }, responsive: true, maintainAspectRatio: false } });
    // ä¿®æ”¹ï¼šä¸å†ç›´æ¥æ“ä½œ style.display
  globalStatsModal.style.display = 'flex'; // å…ˆè®¾ä¸º flex å¸ƒå±€
  setTimeout(() => globalStatsModal.classList.add('show'), 10); // å»¶è¿Ÿä¸€å°ä¼šå†æ·»åŠ  show ç±»ä»¥è§¦å‘åŠ¨ç”»
}
function closeGlobalStatsModal() {
  globalStatsModal.classList.remove('show');
  setTimeout(() => globalStatsModal.style.display = 'none', 300); // ç­‰åŠ¨ç”»ç»“æŸåå†éšè—
}
// --- 8. PWA ä¸é€šçŸ¥ ---
function registerServiceWorker() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js', { type: 'module' }).then(reg => console.log('âœ… SW æ³¨å†ŒæˆåŠŸ', reg)).catch(err => console.error('âŒ SW æ³¨å†Œå¤±è´¥', err)); }
async function requestNotificationPermission() { if (!('Notification' in window)) return false; let p = Notification.permission; if (p === 'denied') return false; if (p === 'default') p = await Notification.requestPermission(); return p === 'granted'; }
async function setupDailyReminder() {
    if (!('serviceWorker' in navigator) || !('PeriodicSyncManager' in window)) return;
    const reg = await navigator.serviceWorker.ready;
    const status = await navigator.permissions.query({ name: 'periodic-background-sync' });
    if (status.state !== 'granted') return;
    try { const tags = await reg.periodicSync.getTags(); if (!tags.includes('daily-reminder')) await reg.periodicSync.register('daily-reminder', { minInterval: 12 * 3600 * 1000 }); } catch (e) { console.error('æ³¨å†Œæ¯æ—¥æé†’å¤±è´¥', e); }
}
function scheduleSessionReminders() { /* Placeholder */ }
function updateSWTodo() {
    if (!navigator.serviceWorker.controller) return;
    const stats = aggregateAllStats();
    const setsToReview = Object.keys(stats.setsToReview);
    let message = 'ä»Šå¤©æœ‰æ–°çš„å­¦ä¹ ä»»åŠ¡åœ¨ç­‰ä½ ã€‚';
    if (setsToReview.length > 0) message = `ä»Šå¤©å»ºè®®ä¼˜å…ˆå¤ä¹ ï¼š${setsToReview.join(', ')}ã€‚`;
    else if (stats.totalCards > 0) message = 'å¤ªæ£’äº†ï¼æ‰€æœ‰å¡ç‰‡éƒ½å·²ç†Ÿç»ƒæŒæ¡ã€‚';
    navigator.serviceWorker.controller.postMessage({ action: 'set-daily-todo', payload: { message } });
}
async function sendTestPush() {
    if (!await requestNotificationPermission()) return;
    const testType = testPushSelect.value;
    let payload = {};
    // ... (rest of sendTestPush logic)
    if (navigator.serviceWorker.controller) { /* ... */ } else { alert('Service Worker æœªå°±ç»ªï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚'); }
}
function setupPWAInstall() {
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'inline-block'; });
    installBtn.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') showToast('å·²å®‰è£…ä¸ºåº”ç”¨ï¼'); deferredPrompt = null; installBtn.style.display = 'none'; });
}

// --- 9. åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š ---
function bindEvents() {
    setSelect.addEventListener('change', (e) => switchCardSet(e.target.value));
    resetBtn.addEventListener('click', () => { if (confirm('ç¡®è®¤é‡ç½®å½“å‰å¡ç‰‡ç»„çš„æ‰€æœ‰è¿›åº¦ï¼Ÿ')) { leitner = initLeitner(); stats = initStats(); persistAll(); renderGrid(); updateStatsUI(); showToast('å½“å‰è¿›åº¦å·²é‡ç½®ã€‚'); } });
    modeToggle.addEventListener('click', () => { if (mode === 'grid') startReviewMode(); else exitReviewMode(); });
    notifyToggle.addEventListener('click', () => { settings.remindersEnabled = !settings.remindersEnabled; saveJSON(getStorageKeys(currentSetId).SETTINGS, settings); updateSettingsUI(); showToast(settings.remindersEnabled ? 'å·²å¼€å¯æ¯æ—¥æé†’' : 'å·²å…³é—­æ¯æ—¥æé†’'); });
    testPushBtn.addEventListener('click', sendTestPush);
    showGlobalStatsBtn.addEventListener('click', showGlobalStats);
    closeModalBtn.addEventListener('click', closeGlobalStatsModal); // <--- ä¿®æ”¹
    window.addEventListener('click', (event) => { if (event.target == globalStatsModal) globalStatsModal.style.display = 'none'; });
    createNewCardBtn.addEventListener('click', openCardEditor);
    closeEditorBtn.addEventListener('click', closeCardEditorModal); // <--- ä¿®æ”¹
    cardEditorForm.addEventListener('submit', saveCard);
    cardBackInput.addEventListener('input', () => { markdownPreview.innerHTML = marked.parse(cardBackInput.value); });
    deleteCardBtn.addEventListener('click', deleteCard);
    window.addEventListener('click', (event) => {
    if (event.target == globalStatsModal) {
      closeGlobalStatsModal(); // <--- ä¿®æ”¹
    }
    if (event.target == cardEditorModal) {
      closeCardEditorModal(); // <--- ä¿®æ”¹
    }
  });
}
function initSetSelector() {
    const lastSetId = localStorage.getItem('flash_last_set_id_v1') || 'threads';
    currentSetId = cardSetsConfig[lastSetId] ? lastSetId : 'threads';

    for (const setId in cardSetsConfig) {
        const option = document.createElement('option');
        option.value = setId;
        option.textContent = cardSetsConfig[setId].name;
        setSelect.appendChild(option);
    }
    setSelect.value = currentSetId;
}
async function initializeApp() {
  // 1. ç»‘å®šUIäº‹ä»¶ (é™¤äº†ç™»å½•)
  initSetSelector();
  bindEvents(); // ç¡®ä¿è¿™ä¸ªå‡½æ•°ä¸åŒ…å«ç™»å½•æŒ‰é’®çš„ç»‘å®š
  setupPWAInstall();

  // 2. ç»‘å®šç™»å½•/ç™»å‡ºæŒ‰é’®äº‹ä»¶
  document.getElementById('loginBtn').addEventListener('click', firebase.signInWithGoogle);
  document.getElementById('logoutBtn').addEventListener('click', firebase.signOut);

  // 3. ã€æ ¸å¿ƒã€‘ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
  firebase.onAuthStateChanged(async (user) => {
    updateAuthUI(user);

    if (user) {
      // --- ç”¨æˆ·ç™»å½•åçš„é€»è¾‘ ---
      console.log(`ç”¨æˆ· ${user.uid} å·²ç™»å½•`);
      
      // a. è§¦å‘æ•°æ®è¿ç§» (åªä¼šæ‰§è¡Œä¸€æ¬¡)
      await migrateLocalDataToFirestore(user.uid);
      
      // b. ã€é‡è¦ã€‘æ”¹é€ æ•°æ®åŠ è½½é€»è¾‘ï¼Œä½¿å…¶ä» Firestore è¯»å–
      // æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€æ­¥æ›¿æ¢ switchCardSet
      showToast('å·²ç™»å½•ï¼Œæ­£åœ¨ä»äº‘ç«¯åŒæ­¥æ•°æ®...');
      // await switchCardSetFromFirestore(currentSetId); 
      console.log("ä¸‹ä¸€æ­¥ï¼šæ”¹é€ æ•°æ®åŠ è½½é€»è¾‘ä»¥ä½¿ç”¨ Firestoreã€‚");

    } else {
      // --- ç”¨æˆ·æœªç™»å½•æˆ–ç™»å‡ºåçš„é€»è¾‘ ---
      console.log("ç”¨æˆ·æœªç™»å½•ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼");
      // ä¿æŒåŸæ ·ï¼Œä» localStorage åŠ è½½æ•°æ®
      await switchCardSet(currentSetId);
    }
  });

  // 4. PWAç›¸å…³åˆå§‹åŒ–
  registerServiceWorker();
  navigator.serviceWorker.ready.then(async () => {
    if (await requestNotificationPermission()) {
      setupDailyReminder();
      // scheduleSessionReminders();
    }
  });
}
window.app = {
  editCard: editCard
};
document.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>